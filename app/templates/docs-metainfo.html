{% extends "default.html" %}

{% block title %}MetaInfo Files{% endblock %}

{% block content %}
<h1>Introduction</h1>

<p>
  The <code>.metainfo.xml</code> file describes the device and firmware and
  is extra metadata added to the firmware archive by the OEM or ODM.
  The file is XML format, and uses a subset of the
  <a href="http://www.freedesktop.org/software/appstream/docs/sect-Quickstart-Addons.html">AppStream</a> component specification.
</p>
<p>
An example <code>metainfo.xml</code> file looks like this:
</p>
<pre class="prettyprint">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!-- Copyright 2018 Richard Hughes &lt;richard@hughsie.com&gt; --&gt;
&lt;component type="firmware"&gt;
  &lt;id&gt;com.hughski.ColorHugALS.firmware&lt;/id&gt;
  &lt;name&gt;ColorHugALS&lt;/name&gt;
  &lt;summary&gt;Firmware for the Hughski ColorHug Ambient Light Sensor&lt;/summary&gt;
  &lt;description&gt;
    &lt;p&gt;
      Updating the firmware on your ColorHugALS device improves performance and
      adds new features.
    &lt;/p&gt;
  &lt;/description&gt;
  &lt;provides&gt;
    &lt;firmware type="flashed"&gt;84f40464-9272-4ef7-9399-cd95f12da696&lt;/firmware&gt;
  &lt;/provides&gt;
  &lt;url type="homepage"&gt;http://www.hughski.com/&lt;/url&gt;
  &lt;metadata_license&gt;CC0-1.0&lt;/metadata_license&gt;
  &lt;project_license&gt;proprietary&lt;/project_license&gt;
  &lt;developer_name&gt;Hughski Limited&lt;/developer_name&gt;
  &lt;releases&gt;
    &lt;release urgency="high" version="3.0.2" date="2017-02-09"&gt;
    &lt;checksum filename="my-custom-name.bin" target="content"/&gt;
      &lt;description&gt;
        &lt;p&gt;This stable release fixes the following bugs:&lt;/p&gt;
        &lt;ul&gt;
          &lt;li&gt;Fix the return code from GetHardwareVersion&lt;/li&gt;
          &lt;li&gt;Scale the output of TakeReadingRaw by the datasheet values&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/description&gt;
    &lt;/release&gt;
  &lt;/releases&gt;
  &lt;!-- we can optionally restrict this update to specific fwupd versions,
       or even previous firmware or bootloader versions --&gt;
  &lt;requires&gt;
    &lt;id compare="ge" version="0.8.0"&gt;org.freedesktop.fwupd&lt;/id&gt;
    &lt;firmware compare="ge" version="0.1.2"/&gt;
    &lt;firmware compare="ge" version="0.3.4"&gt;bootloader&lt;/firmware&gt;
  &lt;/requires&gt;
  &lt;!-- these keywords are optional and are used for searching --&gt;
  &lt;keywords&gt;
    &lt;keyword&gt;bios&lt;/keyword&gt;
    &lt;keyword&gt;dfu&lt;/keyword&gt;
  &lt;/keywords&gt;
&lt;/component&gt;
</pre>

<hr/>
<h2>Which GUID Do I Use?</h2>
<p>
  GUID means 'Globally Unique Identifier' and is a 128-bit integer number used
  to identify a device.
  GUIDs are often formatted as strings such as <code>84f40464-9272-4ef7-9399-cd95f12da696</code>.
  Another name for GUID is UUID ('Universally Unique Identifier') and the two
  terms can be used interchangably.
</p>
<p>
  In fwupd the GUID is generated from the <code>DeviceInstanceId</code> strings,
  so for a single USB device the GUIDs would be generated like this:
</p>
<pre>
$ python
>>> import uuid
>>> print uuid.uuid5(uuid.NAMESPACE_DNS, 'USB\VID_0A5C&amp;PID_6412&amp;REV_0001')
52fd36dc-5904-5936-b114-d98e9d410b25
>>> print uuid.uuid5(uuid.NAMESPACE_DNS, 'USB\VID_0A5C&amp;PID_6412')
7a1ba7b9-6bcd-54a4-8a36-d60cc5ee935c
>>> print uuid.uuid5(uuid.NAMESPACE_DNS, 'USB\VID_0A5C')
ddfc8e56-df0d-582e-af12-c7fa171233dc
</pre>
</p>
  or, using <a href="https://github.com/hughsie/appstream-glib">appstream-glib</a>:
</p>
<pre>
$ appstream-util generate-guid "USB\VID_0A5C&amp;PID_6412&amp;REV_0001"
52fd36dc-5904-5936-b114-d98e9d410b25
</pre>
<p>
  This allows the vendor to choose the GUID for what should match; to match on
  the <code>vendor+product+revision</code> you'd choose the first one, and the
  <code>vendor+device</code> you would use the second.
  We only really use the third GUID for fixing a vendor name, or other very
  broad quirks that apply to all USB devices from a specific vendor.
</p>
<p>
  In the case for PCI devices and other technologies like NVMe, you can dump
  the GUIDs generated by fwupd using this tool:
</p>
<pre>
sudo /usr/libexec/fwupd/fwupdtool --plugin-whitelist nvme get-devices --verbose
...
using e22c4520-43dc-5bb3-8245-5787fead9b63 for NVME\VEN_1179&amp;DEV_010F&amp;REV_01
using 83991323-9951-5adf-b743-d93e882a41e1 for NVME\VEN_1179&amp;DEV_010F
using ad9fe8f7-cdc4-52c9-9fea-31b6f4988ffa for NVME\VEN_1179
...
</pre>
<p>
  More details about the GUID generation scheme used in each plugin can be found
  in the <code>README.md</code> file in each
  <a href="https://github.com/hughsie/fwupd/tree/master/plugins">plugin directory</a>.
</p>
<div class="card mb-3">
  <h3 class="card-header list-group-item-info">Can I match more than one GUID?</h3>
  <div class="card-body">
    <p class="card-text">
      Metainfo files can contain as many lines of
      <code>&lt;firmware type="flashed"&gt;</code>
      as required and any device with any of the GUIDs will match the firmware file.
    </p>
  </div>
</div>

<hr/>
<h2>Restricting using CHID</h2>
<p>
  Newer versions of fwupd can restrict updates to a specific
  <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/dashboard/using-chids">
  Computer Hardware ID</a>, much like Microsoft update:
</p>
<pre>
  &lt;!-- only newer versions of fwupd understand 'hardware' requirements --&gt;
  &lt;requires&gt;
    &lt;id compare="ge" version="1.0.1"&gt;org.freedesktop.fwupd&lt;/id&gt;
    &lt;hardware&gt;6de5d951-d755-576b-bd09-c5cf66b27234&lt;/hardware&gt;
  &lt;/requires&gt;
</pre>
<p>
  CHIDs can also be added or removed in the LVFS web UI, but only before
  the firmware is published to stable channel.
</p>
<figure class="text-center">
  <img src="/img/component-requirements.png" class="p-3 border border-info rounded figure-img img-fluid" alt="component requirements">
  <figcaption class="figure-caption">Modifying requirements of an uploaded firmware.</figcaption>
</figure>

<hr/>
<h2>Restricting using other firmware version</h2>
<p>
  Newer versions of fwupd can restrict updates on one device depending on
  the version of firmware on another device.
  This is most useful when requiring a minimum EC controller version before
  updating a system firmware, or when a modem firmware needs a specific fix
  for the baseband firmware:
</p>
<pre>
  &lt;!-- only newer versions of fwupd understand 'other firmware' requirements --&gt;
  &lt;requires&gt;
    &lt;id compare="ge" version="1.1.3"&gt;org.freedesktop.fwupd&lt;/id&gt;
    &lt;firmware compare="ge" version="0.1.2"&gt;6de5d951-d755-576b-bd09-c5cf66b27234&lt;/firmware&gt;
  &lt;/requires&gt;
</pre>

<hr/>
<h2>Restricting direct downloads</h2>
<p>
  If you'd rather not have users downloading the .cab archive directly you
  can opt to hide the direct download links in the LVFS search results.
  To do this, add this to the metainfo file:
</p>
<pre>
  &lt;!-- most OEMs do not need to do this... --&gt;
  &lt;custom&gt;
    &lt;value key="LVFS::InhibitDownload"/&gt;
  &lt;/custom&gt;
</pre>

<hr/>
<h2>Settting the Version Format</h2>
<p>
  Some hardware returns the version number as a string such as
  <code>1.23.4567</code>, and this is easily handled as a <a href="https://semver.org/">semantic version</a>.
  In other cases we are not so lucky, and the hardware returns a <code>uint16_t</code> or <code>uint32_t</code>
  with no extra metadata about how it should be formatted.
  This lack of specification precision means that different vendors have chosen
  to convert the large integer number to various different forms:
</p>
<table class="table">
  <tr class="row table-borderless">
    <th class="col-sm-2">ID</th>
    <th class="col-sm-2">Example</th>
    <th class="col-sm-6">Description</th>
    <th class="col-sm-2">fwupd supported</th>
  </tr>
  <tr class="row">
    <td class="col-sm-2"><code>plain</code></td>
    <td class="col-sm-2"><code>12345678</code></td>
    <td class="col-sm-6">Plain integer</td>
    <td class="col-sm-2"><code>&gt;=1.2.0</code></td>
  </tr>
  <tr class="row">
    <td class="col-sm-2"><code>pair</code></td>
    <td class="col-sm-2"><code>1234.5678</code></td>
    <td class="col-sm-6">Two large numbers</td>
    <td class="col-sm-2"><code>&gt;=1.2.0</code></td>
  </tr>
  <tr class="row">
    <td class="col-sm-2"><code>triplet</code></td>
    <td class="col-sm-2"><code>12.34.5678</code></td>
    <td class="col-sm-6">Microsoft-style</td>
    <td class="col-sm-2"><code>&gt;=1.1.0</code></td>
  </tr>
  <tr class="row">
    <td class="col-sm-2"><code>quad</code></td>
    <td class="col-sm-2"><code>12.34.56.78</code></td>
    <td class="col-sm-6">Dell-style</td>
    <td class="col-sm-2"><code>&gt;=1.1.0</code></td>
  </tr>
  <tr class="row">
    <td class="col-sm-2"><code>intel-me</code></td>
    <td class="col-sm-2"><code>12.2.34.5678</code></td>
    <td class="col-sm-6">Intel ME-style, with bitshift</td>
    <td class="col-sm-2"><code>&gt;=1.2.0</code></td>
  </tr>
  <tr class="row">
    <td class="col-sm-2"><code>intel-me2</code></td>
    <td class="col-sm-2"><code>1.2.34.5678</code></td>
    <td class="col-sm-6">Intel ME-style</td>
    <td class="col-sm-2"><code>&gt;=1.2.0</code></td>
  </tr>
  <tr class="row">
    <td class="col-sm-2"><code>bcd</code></td>
    <td class="col-sm-2"><code>1.2</code></td>
    <td class="col-sm-6">Binary coded decimal</td>
    <td class="col-sm-2"><code>&gt;=1.1.0</code></td>
  </tr>
</table>
<p>
  To override the default of <code>triplet</code> vendors can ship extra metadata
  in the <code>metainfo.xml</code> file:
</p>
<pre>
  &lt;!-- most devices do not need to do this... --&gt;
  &lt;custom&gt;
    &lt;id compare="ge" version="1.2.0"&gt;org.freedesktop.fwupd&lt;/id&gt;
    &lt;value key="LVFS::VersionFormat"&gt;intel-me&lt;/value&gt;
  &lt;/custom&gt;
</pre>
<p>
  Various security teams also want us to always show the device firmware version
  with the correct format, even if an update is not available.
  This may be for audit reasons, or just so customers know the version of the
  firmware compared to release notes written for another operating system.
  For instance, if the vendor release notes says the firmware should be any
  version above <code>39.0.45.x</code> (formatted as a quad) and the user is running
  <code>39.0.11522</code> (formatted as a triplet) it is not clear to the user what to do.
</p>
<p>
  To change from the default <code>triplet</code> version format we can set
  a fwupd <em>quirk </em>on the hardware device.
  For instance, changing the UEFI
  <a href="https://github.com/hughsie/fwupd/blob/master/plugins/uefi/uefi.quirk">Lenovo ME device</a>
  to use the <code>intel-me</code> format.
  Quirk files can be added upstream for future fwupd versions, or simply copied to
  <code>/usr/share/fwupd/quirks.d</code>.
  The fwupd daemon will detect the new file and refresh devices as required.
</p>

<hr/>
<h2>Style Guide</h2>

<table class="table">
  <tr class="row table-borderless">
    <th class="col-sm-2"><code>&lt;id&gt;</code></th>
    <td class="col-sm-10">
      <ul>
        <li>
          Use a reverse-DNS vendor prefix similar to Java, e.g.
          <code>com.hughski</code> or <code>org.freedesktop</code>
        </li>
        <li>
          The ID has to be totally specific to the device.
          You can use the partial GUID appended if this helps, e.g.
          <code>com.hughski.ColorHug84f40464.firmware</code>
        </li>
        <li>
          Always use a <code>.firmware</code> suffix
        </li>
      </ul>
    </td>
  </tr>
  <tr class="row">
    <th class="col-sm-2"><code>&lt;name&gt;</code></th>
    <td class="col-sm-10">
      <ul>
        <li>Use a short device name, e.g. <em>"ThinkPad"</em> or <em>"ColorHug"</em>.</li>
        <li>Use a UTF-8 character (e.g. ™ or ®) rather than <code>(R)</code> if required</li>
        <li>Don't include the vendor name</li>
      </ul>
    </td>
  </tr>
  <tr class="row">
    <th class="col-sm-2"><code>&lt;summary&gt;</code></th>
    <td class="col-sm-10">
      <ul>
        <li>Refer to the type of hardware, e.g. <em>"Firmware for the Hughski ColorHug Colorimeter"</em></li>
        <li>Include the vendor name before the full device description</li>
        <li>Use a UTF-8 character (e.g. ™ or ®) rather than <code>(R)</code> if required</li>
      </ul>
    </td>
  </tr>
  <tr class="row">
    <th class="col-sm-2"><code>&lt;description&gt;</code></th>
    <td class="col-sm-10">
      <ul>
        <li>
          Try to avoid explaining the implementation details of the fix, e.g.
          <em>"Ensure accurate color profile creation with high screen brightness."</em>
          rather than
          <em>"Fix overflow in counter when over 500 Lux detected."</em>
        </li>
        <li>
          Do not use overly technical descriptions when simpler text would suffice, e.g. use
          <em>"Fix LED color during system start up."</em> rather than
          <em>"Fix LED color during POST."</em>
        </li>
        <li>
          Try to describe fixed bugs and new features from the point of view of the user
          and how it affects them
        </li>
        <li>
          For security or important updates also include the effect of not applying the update, e.g.
          <em>"Disk corruption resulting in possible data loss may occur until this update is installed."</em>
        </li>
      </ul>
    </td>
  </tr>
</table>
{% endblock %}
